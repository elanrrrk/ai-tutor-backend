// === БАЗА ДАННЫХ КЕЙСОВ И ИДЕАЛЬНЫХ РЕШЕНИЙ ===
const CASES_DB = {
  "ba_req_shop": {
    title: "Кейс 1: Сбор требований для интернет-магазина",
    description: `
      ЗАКАЗЧИК: Владелец сети магазинов автозапчастей.
      ПРОБЛЕМА: Сейчас продажи идут только оффлайн. Хотим выйти в онлайн.
      
      СЫРЫЕ ДАННЫЕ ОТ ЗАКАЗЧИКА (интервью):
      "Ну нам нужен сайт, чтобы человек зашел, вбил номер детали и купил. 
      Важно, чтобы видно было, есть ли деталь на складе в Химках или в Мытищах. 
      Оплата картой нужна. И чтобы мне смска приходила, когда заказ упал."
      
      ЗАДАНИЕ:
      1. Сформулируйте 3 функциональных требования (в формате User Story).
      2. Сформулируйте 2 нефункциональных требования (ограничения).
      3. Опишите критерии приемки (Acceptance Criteria) для функции "Поиск детали".
    `,
    ideal_solution: `
      ИДЕАЛЬНОЕ РЕШЕНИЕ (ЭТАЛОН):
      
      1. Functional Requirements (User Stories):
         - Как покупатель, я хочу искать детали по VIN-номеру или артикулу, чтобы быстро находить нужную запчасть.
         - Как покупатель, я хочу видеть остатки товара в конкретном филиале (Химки/Мытищи), чтобы выбрать удобный пункт самовывоза.
         - Как владелец, я хочу получать SMS-уведомления о новых заказах, чтобы оперативно реагировать.

      2. Non-functional Requirements:
         - Performance: Поиск по базе из 1 млн товаров должен занимать не более 2 секунд.
         - Availability: Актуальность остатков на сайте должна обновляться не реже чем раз в 15 минут (синхронизация с 1С).

      3. Acceptance Criteria (Поиск):
         - Если товар найден: отображается карточка с фото, ценой и наличием по складам.
         - Если товар не найден: отображается сообщение "Нет в наличии" и форма "Сообщить о поступлении".
         - Поиск работает как по полному совпадению, так и по частичному вводу (от 3 символов).
    `
  },

  "ba_process_hr": {
    title: "Кейс 2: Оптимизация процесса найма (As-Is -> To-Be)",
    description: `
      СИТУАЦИЯ (AS-IS):
      В IT-компании процесс выхода нового сотрудника (Onboarding) занимает 5 дней.
      1. Рекрутер пишет письмо сисадмину: "Заведи почту".
      2. Сисадмин читает письмо (иногда через день), заводит почту, кидает пароль рекрутеру.
      3. Рекрутер пишет завхозу: "Нужен пропуск и ноутбук".
      4. Завхоз ищет свободный ноутбук на складе (в Excel таблице).
      5. В итоге в первый день сотрудник сидит без доступа в Jira и без ноутбука.
      
      ЗАДАНИЕ:
      1. Назовите 2 главных "узких места" (Bottlenecks) процесса.
      2. Предложите схему TO-BE (как должно быть) с использованием автоматизации.
      3. Какие метрики улучшатся?
    `,
    ideal_solution: `
      ИДЕАЛЬНОЕ РЕШЕНИЕ (ЭТАЛОН):

      1. Узкие места (Bottlenecks):
         - Ручная коммуникация (Email-пинг-понг) между отделами. Зависимость от человеческого фактора (сисадмин забыл прочитать).
         - Ручной учет оборудования (Excel). Нет понимания актуальных остатков ноутбуков.

      2. Процесс TO-BE:
         - Внедрение Service Desk (Jira Service Management / ServiceNow).
         - При смене статуса кандидата на "Hired" в HR-системе, автоматически создаются тикеты на Сисадмина (аккаунты) и Завхоза (оборудование).
         - Используется SSO (Single Sign-On): учетная запись создается скриптом автоматически, без участия админа.

      3. Метрики:
         - Time-to-Productivity: сокращение простоя сотрудника с 5 дней до 0 (все готово к выходу).
         - SLA (время реакции обеспечивающих отделов): будет регламентировано (например, 4 часа на подготовку).
    `
  }
};

export async function onRequestPost(context) {
  try {
    const { request, env } = context;
    const body = await request.json();
    
    // Проверка ключа
    if (!env.GROQ_API_KEY) {
      return new Response(JSON.stringify({ result: "ОШИБКА: Нет ключа API." }), { headers: { "Content-Type": "application/json" }});
    }

    const currentCase = CASES_DB[body.case_id];
    if (!currentCase) return new Response(JSON.stringify({ result: "Кейс не найден" }));

    // === ГЛАВНАЯ ЛОГИКА СРАВНЕНИЯ ===
    const prompt = `
      Ты Lead Business Analyst, который проводит собеседование.

      ТЕКУЩИЙ КЕЙС:
      ${currentCase.description}

      ЭТАЛОННОЕ РЕШЕНИЕ (ТО, К ЧЕМУ МЫ СТРЕМИМСЯ):
      ${currentCase.ideal_solution}

      ОТВЕТ КАНДИДАТА:
      ${body.solution}

      ИНСТРУКЦИЯ ПО ПРОВЕРКЕ:
      Сравни ответ кандидата с эталоном. Не выдавай эталон в ответе прямо, но используй его для оценки.
      
      СТРУКТУРА ТВОЕГО ОТВЕТА:
      1. <b>Оценка:</b> X/10.
      2. <b>Верно подмечено:</b> (Что совпало с эталоном).
      3. <b>Упущено / Ошибки:</b> (Чего не хватает по сравнению с эталоном или где логическая ошибка).
      4. <b>Рекомендация:</b> (Как докрутить ответ до уровня Senior).
      
      Отвечай на русском языке, профессионально, используй HTML теги.
    `;

    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${env.GROQ_API_KEY}`
      },
      body: JSON.stringify({
        model: "llama-3.3-70b-versatile",
        messages: [{ role: "user", content: prompt }],
        temperature: 0.3 // Низкая температура для более строгой проверки
      })
    });

    const data = await response.json();
    const aiText = data.choices?.[0]?.message?.content || "Ошибка генерации";

    return new Response(JSON.stringify({ result: aiText }), {
      headers: { "Content-Type": "application/json" },
    });

  } catch (err) {
    return new Response(JSON.stringify({ result: "Ошибка: " + err.message }), { status: 200 });
  }
}
